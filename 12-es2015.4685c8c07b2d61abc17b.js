(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{"5lbs":function(e,t,i){"use strict";i.r(t),i.d(t,"billGenerateModule",function(){return M});var n=i("ofXK"),l=i("TEn/"),o=i("3Pt+"),a=i("mrSG"),s=i("PqYM"),r=i("IzEk"),c=i("lJxs"),b=i("fXoL"),h=i("tyNb"),d=i("27b0"),g=i("fU03"),u=i("7zfz"),m=i("tp0D"),p=i("dpPO"),f=i("Gxio"),v=i("sYmb");let y=(()=>{class e{constructor(e,t,i,n,l,o){this.router=e,this.dbconfig=t,this.location=i,this.util=n,this.messageService=l,this.dbprovider=o,this.billTableName="billDetail",this.loginActivityTableName="loginActivities",this.vehicleTableName="vehicle",this.billNeedToGenerate=[],this.savedSuccessMessage="Data saved successfully",this.disableGenerate=!1;var a=new Date,s=a.getMonth()+1;this.selectedYearmonth=s<10?a.getFullYear()+"-0"+s:a.getFullYear()+"-"+s,this.logEntry({message:" ",type:"INFO"})}backButtonOnclick(){this.location.back()}filterValidAccounts(){this.disableGenerate=!0,console.log(this.selectedYearmonth);var e=this.selectedYearmonth.split("-")[1],t=this.selectedYearmonth.split("-")[0];const i=new Date(Number(t),Number(e),0,23,59,59);var n=[];this.dbprovider.fetchDocsWithRelationshipByType(this.vehicleTableName,!0,{childreference:["account"]}).then(l=>{console.log(l),l&&"SUCCESS"==l.status?l.records.length>0&&(l.records.forEach(e=>{e.accounts&&e.accounts.length>0&&e.accounts.forEach(t=>{!t.closeDate&&t.openDate<i.getTime()&&(delete e.accounts,t.vehicle=e,n.push(t))})}),console.log(n),this.billGeneration(n,e,t)):(this.messageService.add({key:"billgen",severity:"error",summary:l.message,detail:"",closable:!0}),this.disableGenerate=!1)})}billGeneration(e,t,i){return Object(a.a)(this,void 0,void 0,function*(){console.log(e),e.length>0?(this.logEntry({message:e.length+" vehicle available for selected month("+t+"-"+i+") bill generation",type:"INFO"}),e.forEach(e=>Object(a.a)(this,void 0,void 0,function*(){let n=yield this.dbprovider.fetchDocsWithoutRelationshipUsingFindOption({selector:{"data.account":e.id,"data.billMonth":Number(t),"data.billYear":Number(i),"data.type":this.billTableName},sort:["data.account"]});if(this.setLogMessage({message:"Bill generation started for "+e.vehicle.vehicleNumber,type:"INFO"}),n&&"SUCCESS"==n.status){if(n.records.length>0)console.log(n),this.setLogMessage({message:"Already bill generated for "+e.vehicle.vehicleNumber,type:"INFO"});else{var l=JSON.parse(JSON.stringify(this.dbconfig.configuration.tableStructure[this.billTableName]));l.totalAmount=e.rentPlan_lookup.rentAmount,l.receivedAmount=0,l.pendingAmount=e.rentPlan_lookup.rentAmount,l.billMonth=Number(t),l.billYear=Number(i),l.account=e.id,this.dbprovider.save(this.billTableName,l).then(t=>{this.logEntry("SUCCESS"==t.status?{message:"Bill generated for "+e.vehicle.vehicleNumber+" and bill amount is "+l.totalAmount+" Rs",type:"SUCCESS"}:{message:"Bill generation failed for "+e.vehicle.vehicleNumber,type:"ERR"})}).catch(e=>{console.log(e),this.messageService.add({key:"accCreation",severity:"error",summary:e,detail:""})})}console.log("bill ==",n)}else this.logEntry({message:"Bill generation failed for "+e.vehicle.vehicleNumber,type:"ERR"})})),this.disableGenerate=!1):(this.logEntry({message:"There is no vehicle available for selected month("+t+"-"+i+") bill generation",type:"INFO"}),this.disableGenerate=!1)})}setLogMessage(e){return Promise.resolve(this.logEntry(e))}logEntry(e){var t=[];t.push(e),this.logStream$=Object(s.a)(0).pipe(Object(r.a)(t.length),Object(c.a)(e=>t[e]))}}return e.\u0275fac=function(t){return new(t||e)(b.Mb(h.g),b.Mb(d.a),b.Mb(n.h),b.Mb(g.a),b.Mb(u.h),b.Mb(m.a))},e.\u0275cmp=b.Gb({type:e,selectors:[["billGenerate"]],decls:20,vars:11,consts:[["no-border",""],["slot","start"],["slot","start",3,"disabled","click"],["name","arrow-back",2,"font-size","30px","color","black"],["size","large",1,"ion-text-center"],[2,"position","fixed"],["ion-fixed","",1,"center"],[2,"padding-right","5px","padding-left","5px"],["type","month","id","start","name","start","min","2000-01","value","2021-03",2,"background-color","lightgray","align-self","center","padding-bottom","3px","padding-top","2px",3,"ngModel","ngModelChange"],["slot","end",3,"disabled","click"],["theme","light","title","Bill generation logs",3,"logStream","animated","icons"],["key","billgen","position","bottom-center"]],template:function(e,t){1&e&&(b.Sb(0,"ion-header",0),b.Sb(1,"ion-toolbar"),b.Sb(2,"ion-buttons",1),b.Sb(3,"ion-button",2),b.ac("click",function(){return t.backButtonOnclick()}),b.Sb(4,"h2"),b.Nb(5,"ion-icon",3),b.Rb(),b.Rb(),b.Rb(),b.Sb(6,"ion-title",4),b.Ec(7),b.dc(8,"translate"),b.Rb(),b.Rb(),b.Rb(),b.Sb(9,"ion-content"),b.Sb(10,"ion-toolbar",5),b.Sb(11,"ion-item",6),b.Sb(12,"label",7),b.Ec(13,"Month : "),b.Rb(),b.Sb(14,"input",8),b.ac("ngModelChange",function(e){return t.selectedYearmonth=e}),b.Rb(),b.Sb(15,"ion-button",9),b.ac("click",function(){return t.filterValidAccounts()}),b.Ec(16,"Generate "),b.Rb(),b.Rb(),b.Rb(),b.Nb(17,"log-monitor",10),b.dc(18,"async"),b.Nb(19,"p-toast",11),b.Rb()),2&e&&(b.Ab(3),b.kc("disabled",t.disableGenerate),b.Ab(4),b.Gc(" ",b.ec(8,7,"billGenerate.title")," "),b.Ab(7),b.jc("ngModel",t.selectedYearmonth),b.Ab(1),b.kc("disabled",t.disableGenerate),b.Ab(2),b.jc("logStream",b.ec(18,9,t.logStream$))("animated",!0)("icons",!0))},directives:[l.m,l.z,l.d,l.c,l.n,l.y,l.j,l.p,o.a,o.i,o.l,p.a,f.a],pipes:[v.c,n.b],styles:[".center[_ngcontent-%COMP%]{display:flex;justify-content:center;align-content:center;align-items:center;width:41%;margin:auto;min-width:300px}"]}),e})();var S=i("/RsI"),N=i("jIHw"),k=i("7kUa");const E=[{path:"",component:y}];let M=(()=>{class e{}return e.\u0275mod=b.Kb({type:e}),e.\u0275inj=b.Jb({factory:function(t){return new(t||e)},imports:[[h.k.forChild(E),n.c,o.f,l.A,S.b,N.c,k.b,f.b,v.b,p.b],h.k]}),e})()}}]);