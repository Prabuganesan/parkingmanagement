(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{"5lbs":function(e,t,i){"use strict";i.r(t),i.d(t,"billGenerateModule",function(){return E});var l=i("ofXK"),o=i("TEn/"),a=i("3Pt+"),n=i("mrSG"),s=i("PqYM"),r=i("IzEk"),c=i("lJxs"),b=i("fXoL"),h=i("tyNb"),d=i("27b0"),u=i("fU03"),m=i("7zfz"),g=i("tp0D"),v=i("dpPO"),p=i("Gxio"),y=i("sYmb");let f=(()=>{class e{constructor(e,t,i,l,o,a){this.router=e,this.dbconfig=t,this.location=i,this.util=l,this.messageService=o,this.dbprovider=a,this.billTableName="billDetail",this.accountTableName="account",this.loginActivityTableName="loginActivities",this.vehicleTableName="vehicle",this.billNeedToGenerate=[],this.savedSuccessMessage="Data saved successfully",this.disableGenerate=!1;var n=new Date,s=n.getMonth()+1;this.selectedYearmonth=s<10?n.getFullYear()+"-0"+s:n.getFullYear()+"-"+s,this.logEntry({message:" ",type:"INFO"})}backButtonOnclick(){this.location.back()}filterValidAccounts(){this.disableGenerate=!0,console.log(this.selectedYearmonth);var e=this.selectedYearmonth.split("-")[1],t=this.selectedYearmonth.split("-")[0],i=new Date,l=i.getMonth()+1;if(Number(t)>i.getFullYear())return this.messageService.add({key:"billgen",severity:"error",summary:"Please choose year below or equal to current year",detail:"",closable:!0}),void(this.disableGenerate=!1);if(Number(t)==i.getFullYear()&&Number(e)>l)return this.messageService.add({key:"billgen",severity:"error",summary:"Please choose month below or equal to current month",detail:"",closable:!0}),void(this.disableGenerate=!1);const o=new Date(Number(t),Number(e),0,23,59,59);var a=[];this.dbprovider.fetchDocsWithRelationshipByType(this.vehicleTableName,!0,{childreference:["account"]}).then(i=>{console.log(i),i&&"SUCCESS"==i.status?i.records.length>0?(i.records.forEach(e=>{e.accounts&&e.accounts.length>0&&e.accounts.forEach(t=>{!t.closeDate&&t.openDate<o.getTime()&&(delete e.accounts,t.vehicle=e,a.push(t))})}),console.log(a),this.billGeneration(a,e,t)):this.disableGenerate=!1:(this.messageService.add({key:"billgen",severity:"error",summary:i.message,detail:"",closable:!0}),this.disableGenerate=!1)})}billGeneration(e,t,i){return Object(n.a)(this,void 0,void 0,function*(){console.log(e),e.length>0?(this.logEntry({message:e.length+" vehicle available for selected month("+t+"-"+i+") bill generation",type:"INFO"}),e.forEach(e=>Object(n.a)(this,void 0,void 0,function*(){let l=yield this.dbprovider.fetchDocsWithoutRelationshipUsingFindOption({selector:{"data.account":e.id,"data.billMonth":Number(t),"data.billYear":Number(i),"data.type":this.billTableName},sort:["data.account"]});if(this.setLogMessage({message:"Bill generation started for "+e.vehicle.vehicleNumber,type:"INFO"}),l&&"SUCCESS"==l.status){if(l.records.length>0)console.log(l),this.setLogMessage({message:"Already bill generated for "+e.vehicle.vehicleNumber,type:"INFO"});else{this.util.billGenerate=!0;var o=JSON.parse(JSON.stringify(this.dbconfig.configuration.tableStructure[this.billTableName]));o.totalAmount=e.rentPlan_lookup.rentAmount,o.receivedAmount=0,o.pendingAmount=e.rentPlan_lookup.rentAmount,o.billMonth=Number(t),o.billYear=Number(i),o.account=e.id,this.dbprovider.save(this.billTableName,o).then(t=>{"SUCCESS"==t.status?(this.saveAccount(e,o),this.logEntry({message:"Bill generated for "+e.vehicle.vehicleNumber+" and bill amount is "+o.totalAmount+" Rs",type:"SUCCESS"})):this.logEntry({message:"Bill generation failed for "+e.vehicle.vehicleNumber,type:"ERR"})}).catch(e=>{console.log(e),this.messageService.add({key:"accCreation",severity:"error",summary:e,detail:""})})}console.log("bill ==",l)}else this.logEntry({message:"Bill generation failed for "+e.vehicle.vehicleNumber,type:"ERR"})})),this.disableGenerate=!1):(this.logEntry({message:"There is no vehicle available for selected month("+t+"-"+i+") bill generation",type:"INFO"}),this.disableGenerate=!1)})}saveAccount(e,t){console.log(e),e.totalBillAmount=e.totalBillAmount+Number(t.totalAmount),e.receivedAmount||(e.receivedAmount=0),this.dbprovider.save(this.accountTableName,e).then(e=>{console.log(e)}).catch(e=>{console.log(e)})}setLogMessage(e){return Promise.resolve(this.logEntry(e))}logEntry(e){var t=[];t.push(e),this.logStream$=Object(s.a)(0).pipe(Object(r.a)(t.length),Object(c.a)(e=>t[e]))}}return e.\u0275fac=function(t){return new(t||e)(b.Mb(h.g),b.Mb(d.a),b.Mb(l.h),b.Mb(u.a),b.Mb(m.h),b.Mb(g.a))},e.\u0275cmp=b.Gb({type:e,selectors:[["billGenerate"]],decls:19,vars:11,consts:[["no-border","",1,"pm-header"],[1,"pm-toolbar"],["slot","start",1,"pm-clickaction"],[3,"disabled","click"],["name","arrow-back"],["size","large",1,"ion-text-center","pm-header-title"],[1,"pm-content"],[1,"pm-bg-header"],["lines","none"],["type","month","id","start","name","start","min","2000-01","value","2021-03",3,"ngModel","ngModelChange"],["slot","end",3,"disabled","click"],["theme","light","title","Bill generation logs",3,"logStream","animated","icons"],["key","billgen","position","bottom-center"]],template:function(e,t){1&e&&(b.Sb(0,"ion-header",0),b.Sb(1,"ion-toolbar",1),b.Sb(2,"ion-buttons",2),b.Sb(3,"ion-button",3),b.ac("click",function(){return t.backButtonOnclick()}),b.Nb(4,"ion-icon",4),b.Rb(),b.Rb(),b.Sb(5,"ion-title",5),b.Ec(6),b.dc(7,"translate"),b.Rb(),b.Rb(),b.Rb(),b.Sb(8,"ion-content",6),b.Sb(9,"div",7),b.Sb(10,"ion-item",8),b.Sb(11,"label"),b.Ec(12,"Month : "),b.Rb(),b.Sb(13,"input",9),b.ac("ngModelChange",function(e){return t.selectedYearmonth=e}),b.Rb(),b.Sb(14,"ion-button",10),b.ac("click",function(){return t.filterValidAccounts()}),b.Ec(15,"Generate "),b.Rb(),b.Rb(),b.Rb(),b.Nb(16,"log-monitor",11),b.dc(17,"async"),b.Nb(18,"p-toast",12),b.Rb()),2&e&&(b.Ab(3),b.kc("disabled",t.disableGenerate),b.Ab(3),b.Gc(" ",b.ec(7,7,"billGenerate.title")," "),b.Ab(7),b.jc("ngModel",t.selectedYearmonth),b.Ab(1),b.kc("disabled",t.disableGenerate),b.Ab(2),b.jc("logStream",b.ec(17,9,t.logStream$))("animated",!0)("icons",!0))},directives:[o.n,o.A,o.e,o.d,o.o,o.z,o.k,o.q,a.a,a.i,a.l,v.a,p.a],pipes:[y.c,l.b],styles:[".pm-content[_ngcontent-%COMP%]{--overflow:hidden}"]}),e})();var S=i("/RsI"),N=i("jIHw"),k=i("7kUa");const A=[{path:"",component:f}];let E=(()=>{class e{}return e.\u0275mod=b.Kb({type:e}),e.\u0275inj=b.Jb({factory:function(t){return new(t||e)},imports:[[h.k.forChild(A),l.c,a.f,o.B,S.b,N.c,k.b,p.b,y.b,v.b],h.k]}),e})()}}]);